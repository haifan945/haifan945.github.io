import{_ as ve,r as d,ak as ye,c as P,o as he,a as h,b as N,e as a,w as s,ab as p,E as be,f as we,d as o,u as U,D as xe,J as R,N as Ve,y as O,t as g,l as k,I as Te,F as Se,m as Ce,O as ke,ae as Y,n as Ee,P as De,q as Ne,X as Ue,s as Me,U as $e,V as ze,S as Be,Q as Fe,R as Ie,T as qe,Y as Oe}from"./index-bc0a5eae.js";/* empty css                   *//* empty css                  *//* empty css                   *//* empty css                     */import{s as M}from"./request-cb2fba24.js";/* empty css                  *//* empty css                 *//* empty css                      */import{g as Ae}from"./user-7078cdab.js";const Le=c=>M({url:"/notifications",method:"post",data:c}),Pe=c=>M({url:"/notifications",method:"get",params:c}),Re=(c,m)=>M({url:`/notifications/${c}`,method:"put",data:m}),H=c=>M({url:`/notifications/${c}`,method:"delete"});const Ye={class:"notifications-container"},He={class:"action-bar"},je={key:0},Je={key:1},Qe={class:"action-buttons"},Xe={class:"pagination-container"},Ge={style:{display:"flex",gap:"10px","align-items":"center"}},Ke={style:{"margin-top":"10px","font-size":"12px",color:"#999"}},We={class:"dialog-footer"},Ze={__name:"Notifications",setup(c){const m=d(!1),$=d("新建通知"),T=d(!1),v=d(null),b=d([]),z=d([]),A=d([]),w=d(1),x=d(20),i=d(1),y=d("days"),n=d({title:"",content:"",type:"system",target_type:"all",status:"draft",publish_time:new Date().toISOString().slice(0,19).replace("T"," "),expire_time:null,specific_users:[]}),j={title:[{required:!0,message:"请输入通知标题",trigger:"blur"}],content:[{required:!0,message:"请输入通知内容",trigger:"blur"}],type:[{required:!0,message:"请选择通知类型",trigger:"change"}],target_type:[{required:!0,message:"请选择目标类型",trigger:"change"}],status:[{required:!0,message:"请选择发布状态",trigger:"change"}],publish_time:[{required:!0,message:"请选择发布时间",trigger:"change"}]},J=()=>new Date().toISOString().slice(0,19).replace("T"," "),B=()=>{if(!i.value||i.value<1){p.warning("请输入有效的数值");return}const e=new Date;try{switch(y.value){case"hours":e.setHours(e.getHours()+i.value);break;case"days":e.setDate(e.getDate()+i.value);break;case"months":e.setMonth(e.getMonth()+i.value);break;case"years":e.setFullYear(e.getFullYear()+i.value);break;default:p.warning("请选择有效的时间单位");return}n.value.expire_time=e.toISOString().slice(0,19).replace("T"," ")}catch(t){console.error("计算过期时间失败:",t),p.error("计算过期时间失败")}};ye([i,y],()=>{B()},{immediate:!0});const L=e=>{if(!e)return"-";const t=new Date(e),V=t.getFullYear(),f=String(t.getMonth()+1).padStart(2,"0"),u=String(t.getDate()).padStart(2,"0"),S=String(t.getHours()).padStart(2,"0"),F=String(t.getMinutes()).padStart(2,"0"),I=String(t.getSeconds()).padStart(2,"0");return`${V}-${f}-${u} ${S}:${F}:${I}`},E=async()=>{try{T.value=!0;const e=await Pe();z.value=e||[]}catch(e){p.error("加载通知失败"),console.error("加载通知失败:",e)}finally{T.value=!1}},Q=async()=>{try{const e=await Ae();A.value=e||[]}catch(e){console.error("加载用户失败:",e)}},X=P(()=>{const e=(w.value-1)*x.value,t=e+x.value;return z.value.slice(e,t)}),G=P(()=>z.value.length),K=e=>({system:"primary",announcement:"success",personal:"warning"})[e]||"info",W=e=>({system:"系统通知",announcement:"公告",personal:"个人通知"})[e]||e,Z=e=>e==="all"?"success":"warning",ee=e=>e==="all"?"所有用户":"特定用户",te=e=>({draft:"info",published:"success",expired:"danger"})[e]||"info",ae=e=>({draft:"草稿",published:"已发布",expired:"已过期"})[e]||e,le=()=>{n.value.target_type!=="specific_users"&&(n.value.specific_users=[])},se=()=>{$.value="新建通知";const e=J();n.value={title:"",content:"",type:"system",target_type:"all",status:"draft",publish_time:e,expire_time:null,specific_users:[]},i.value=1,y.value="days",B(),v.value&&v.value.clearValidate(),m.value=!0},ne=e=>{$.value="编辑通知",n.value={id:e.id,title:e.title,content:e.content,type:e.type,target_type:e.target_type,status:e.status,publish_time:typeof e.publish_time=="string"?e.publish_time:new Date(e.publish_time).toISOString().slice(0,19).replace("T"," "),expire_time:e.expire_time?typeof e.expire_time=="string"?e.expire_time:new Date(e.expire_time).toISOString().slice(0,19).replace("T"," "):null,specific_users:e.specific_users?Array.isArray(e.specific_users)?e.specific_users.map(t=>t.id):[]:[]},i.value=1,y.value="days",B(),v.value&&v.value.clearValidate(),m.value=!0},oe=()=>{m.value=!1,i.value=1,y.value="days"},re=async()=>{if(v.value)try{await v.value.validate(),T.value=!0;const e={...n.value};e.id?(await Re(e.id,e),p.success("更新成功")):(await Le(e),p.success("创建成功")),m.value=!1,await E()}catch(e){e.name!=="ValidationError"&&(p.error("操作失败"),console.error("提交失败:",e))}finally{T.value=!1}},ie=async e=>{try{await Y.confirm("确定要删除该通知吗？","删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"danger"}),await H(e),p.success("删除成功"),await E()}catch(t){t!=="cancel"&&(p.error("删除失败"),console.error("删除失败:",t))}},ue=async()=>{if(b.value.length!==0)try{await Y.confirm(`确定要删除选中的 ${b.value.length} 条通知吗？`,"批量删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"danger"});const e=b.value.map(t=>t.id);for(const t of e)await H(t);p.success("批量删除成功"),b.value=[],await E()}catch(e){e!=="cancel"&&(p.error("批量删除失败"),console.error("批量删除失败:",e))}},de=e=>{b.value=e},pe=e=>{x.value=e,w.value=1},ce=e=>{w.value=e};return he(async()=>{await E(),await Q()}),(e,t)=>{const V=Ee,f=De,u=Ne,S=Ue,F=Me,I=$e,me=be,D=ze,_=Be,r=Fe,C=Ie,fe=qe,_e=we,ge=Oe;return h(),N("div",Ye,[a(me,{shadow:"hover"},{header:s(()=>[...t[12]||(t[12]=[o("div",{class:"card-header"},[o("span",null,"通知管理")],-1)])]),default:s(()=>[o("div",He,[a(f,{type:"primary",onClick:se},{default:s(()=>[a(V,null,{default:s(()=>[a(U(xe))]),_:1}),t[13]||(t[13]=o("span",null,"新建通知",-1))]),_:1}),a(f,{type:"danger",disabled:b.value.length===0,onClick:ue},{default:s(()=>[a(V,null,{default:s(()=>[a(U(R))]),_:1}),t[14]||(t[14]=o("span",null,"批量删除",-1))]),_:1},8,["disabled"])]),Ve((h(),O(F,{data:X.value,style:{width:"100%"},onSelectionChange:de},{default:s(()=>[a(u,{type:"selection",width:"55"}),a(u,{label:"序号",width:"100"},{default:s(l=>[o("span",null,g((w.value-1)*x.value+l.$index+1),1)]),_:1}),a(u,{prop:"title",label:"通知标题","min-width":"200"}),a(u,{prop:"type",label:"通知类型",width:"120"},{default:s(l=>[a(S,{type:K(l.row.type)},{default:s(()=>[k(g(W(l.row.type)),1)]),_:2},1032,["type"])]),_:1}),a(u,{prop:"target_type",label:"目标类型",width:"120"},{default:s(l=>[a(S,{type:Z(l.row.target_type)},{default:s(()=>[k(g(ee(l.row.target_type)),1)]),_:2},1032,["type"])]),_:1}),a(u,{label:"特定用户",width:"200"},{default:s(l=>[l.row.target_type==="specific_users"&&l.row.specific_users&&Array.isArray(l.row.specific_users)&&l.row.specific_users.length>0?(h(),N("span",je,g(l.row.specific_users.map(q=>q.name).join(", ")),1)):(h(),N("span",Je,"-"))]),_:1}),a(u,{prop:"status",label:"状态",width:"100"},{default:s(l=>[a(S,{type:te(l.row.status)},{default:s(()=>[k(g(ae(l.row.status)),1)]),_:2},1032,["type"])]),_:1}),a(u,{label:"发布时间",width:"180"},{default:s(l=>[o("span",null,g(L(l.row.publish_time)),1)]),_:1}),a(u,{label:"过期时间",width:"180"},{default:s(l=>[o("span",null,g(L(l.row.expire_time)),1)]),_:1}),a(u,{label:"操作",width:"180",fixed:"right"},{default:s(l=>[o("div",Qe,[a(f,{size:"small",onClick:q=>ne(l.row)},{default:s(()=>[a(V,null,{default:s(()=>[a(U(Te))]),_:1}),t[15]||(t[15]=o("span",null,"编辑",-1))]),_:1},8,["onClick"]),a(f,{size:"small",type:"danger",onClick:q=>ie(l.row.id)},{default:s(()=>[a(V,null,{default:s(()=>[a(U(R))]),_:1}),t[16]||(t[16]=o("span",null,"删除",-1))]),_:1},8,["onClick"])])]),_:1})]),_:1},8,["data"])),[[ge,T.value]]),o("div",Xe,[a(I,{"current-page":w.value,"onUpdate:currentPage":t[0]||(t[0]=l=>w.value=l),"page-size":x.value,"onUpdate:pageSize":t[1]||(t[1]=l=>x.value=l),"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:G.value,onSizeChange:pe,onCurrentChange:ce},null,8,["current-page","page-size","total"])])]),_:1}),a(_e,{modelValue:m.value,"onUpdate:modelValue":t[11]||(t[11]=l=>m.value=l),title:$.value,width:"60%","destroy-on-close":""},{footer:s(()=>[o("span",We,[a(f,{onClick:oe},{default:s(()=>[...t[17]||(t[17]=[k("取消",-1)])]),_:1}),a(f,{type:"primary",onClick:re},{default:s(()=>[...t[18]||(t[18]=[k("确定",-1)])]),_:1})])]),default:s(()=>[a(fe,{ref_key:"notificationFormRef",ref:v,model:n.value,rules:j,"label-width":"120px"},{default:s(()=>[a(_,{label:"通知标题",prop:"title"},{default:s(()=>[a(D,{modelValue:n.value.title,"onUpdate:modelValue":t[2]||(t[2]=l=>n.value.title=l),placeholder:"请输入通知标题",maxlength:"100"},null,8,["modelValue"])]),_:1}),a(_,{label:"通知内容",prop:"content"},{default:s(()=>[a(D,{modelValue:n.value.content,"onUpdate:modelValue":t[3]||(t[3]=l=>n.value.content=l),type:"textarea",rows:6,placeholder:"请输入通知内容"},null,8,["modelValue"])]),_:1}),a(_,{label:"通知类型",prop:"type"},{default:s(()=>[a(C,{modelValue:n.value.type,"onUpdate:modelValue":t[4]||(t[4]=l=>n.value.type=l),placeholder:"请选择通知类型",style:{width:"100%"}},{default:s(()=>[a(r,{label:"系统通知",value:"system"}),a(r,{label:"公告",value:"announcement"}),a(r,{label:"个人通知",value:"personal"})]),_:1},8,["modelValue"])]),_:1}),a(_,{label:"目标类型",prop:"target_type"},{default:s(()=>[a(C,{modelValue:n.value.target_type,"onUpdate:modelValue":t[5]||(t[5]=l=>n.value.target_type=l),placeholder:"请选择目标类型",style:{width:"100%"},onChange:le},{default:s(()=>[a(r,{label:"所有用户",value:"all"}),a(r,{label:"特定用户",value:"specific_users"})]),_:1},8,["modelValue"])]),_:1}),n.value.target_type==="specific_users"?(h(),O(_,{key:0,label:"特定用户",prop:"specific_users"},{default:s(()=>[a(C,{modelValue:n.value.specific_users,"onUpdate:modelValue":t[6]||(t[6]=l=>n.value.specific_users=l),multiple:"",placeholder:"请选择用户",style:{width:"100%"},filterable:""},{default:s(()=>[(h(!0),N(Se,null,Ce(A.value,l=>(h(),O(r,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):ke("",!0),a(_,{label:"发布状态",prop:"status"},{default:s(()=>[a(C,{modelValue:n.value.status,"onUpdate:modelValue":t[7]||(t[7]=l=>n.value.status=l),placeholder:"请选择发布状态",style:{width:"100%"}},{default:s(()=>[a(r,{label:"草稿",value:"draft"}),a(r,{label:"已发布",value:"published"}),a(r,{label:"已过期",value:"expired"})]),_:1},8,["modelValue"])]),_:1}),a(_,{label:"发布时间",prop:"publish_time"},{default:s(()=>[a(D,{modelValue:n.value.publish_time,"onUpdate:modelValue":t[8]||(t[8]=l=>n.value.publish_time=l),placeholder:"发布时间",readonly:"",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),a(_,{label:"过期时间",prop:"expire_time"},{default:s(()=>[o("div",Ge,[a(D,{modelValue:i.value,"onUpdate:modelValue":t[9]||(t[9]=l=>i.value=l),type:"number",placeholder:"输入数值",min:"1",style:{width:"120px"}},null,8,["modelValue"]),a(C,{modelValue:y.value,"onUpdate:modelValue":t[10]||(t[10]=l=>y.value=l),placeholder:"选择单位",style:{width:"100px"}},{default:s(()=>[a(r,{label:"小时",value:"hours"}),a(r,{label:"天",value:"days"}),a(r,{label:"月",value:"months"}),a(r,{label:"年",value:"years"})]),_:1},8,["modelValue"])]),o("div",Ke," 计算结果: "+g(n.value.expire_time||"未设置"),1)]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},dt=ve(Ze,[["__scopeId","data-v-0fad7814"]]);export{dt as default};
